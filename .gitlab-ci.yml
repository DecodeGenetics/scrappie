#  Yaml CI config for Gitlab See. http://docs.gitlab.com/ce/ci/yaml/README.html
#  Machine image on which to build, test etc
image: docker-registry.oxfordnanolabs.local:5000/ont-base-ofan-dev:14.04

variables:
  REPO_DEVELOPMENT: "trusty-unstable"
  REPO_STAGING:     "trusty-testing"
  REPO_PRODUCTION:  "trusty-stable"
  PATCH:            $CI_BUILD_ID
  BUILD_DIR:        "build_${CI_BUILD_ID}"

stages:
  - build
  - test
  - publish

before_script:
  - apt-get update
  - apt-get install -y libopenblas-base libopenblas-dev libhdf5-7 libhdf5-dev cmake

building:
  stage: build
  script:
      - mkdir ${BUILD_DIR} && (cd ${BUILD_DIR} && cmake .. && make)
  except:
      #  Don't test tags (just branches)
      #- tags
  artifacts:
    paths:
      - ${BUILD_DIR}/*.deb
      - ${BUILD_DIR}/scrappie

testing:
  stage: test
  script:
      ${BUILD_DIR}/scrappie --threads 1 reads/*.fast5 > test.fa

upload-development:
  stage: publish
  script:
    - echo "$SSH_PRIVATE_KEY" > .privkey
    - chmod 600 .privkey
    - scp -o StrictHostKeyChecking=no -i .privkey ${BUILD_DIR}/*.deb hudson@deb-repo.oxfordnanolabs.local:/var/www/apt/$REPO/
  variables:
    REPO: $REPO_STAGING
  only:
    - dev

upload-staging:
  stage: publish
  script:
    - echo "$SSH_PRIVATE_KEY" > .privkey
    - chmod 600 .privkey
    - scp -o StrictHostKeyChecking=no -i .privkey ${BUILD_DIR}/*.deb hudson@deb-repo.oxfordnanolabs.local:/var/www/apt/$REPO/
  variables:
    REPO: $REPO_STAGING
  only:
    - master

upload-prod:
  stage: publish
  script:
    - echo "$SSH_PRIVATE_KEY" > .privkey
    - chmod 600 .privkey
    - scp -o StrictHostKeyChecking=no -i .privkey ${BUILD_DIR}/*.deb hudson@deb-repo.oxfordnanolabs.local:/var/www/apt/$REPO/
  variables:
    REPO: $REPO_PRODUCTION
  only:
    - /^release-\d+\.\d+(?:.\d+)?(?:-\d+)?$/ # use regexp
